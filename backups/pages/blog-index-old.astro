---
import { getCollection } from 'astro:content';
import MainLayout from '../../layouts/MainLayout.astro';

// Get all blog posts
const blogPosts = await getCollection('blog');

// Sort by date (newest first)
const sortedPosts = blogPosts.sort((a, b) => {
  const dateA = new Date(a.data.date || 0);
  const dateB = new Date(b.data.date || 0);
  return dateB.getTime() - dateA.getTime();
});

// Group posts by category
const categories = [...new Set(blogPosts.flatMap(post => post.data.categories || []))];
---

<MainLayout 
  title="Blog - Basement Waterproofing Guides & Tips | DrySpace" 
  description="Expert insights on basement waterproofing, foundation repair, and home protection. Learn from Toronto's leading waterproofing professionals."
>
  <div class="container mx-auto px-4 py-12">
    <!-- Hero Section -->
    <div class="text-center mb-12">
      <h1 class="text-4xl md:text-5xl font-bold mb-4">Waterproofing Knowledge Center</h1>
      <p class="text-xl text-gray-600 max-w-3xl mx-auto">
        Expert insights, tips, and guides to protect your Toronto home from water damage
      </p>
    </div>

    <!-- Category Filter -->
    <div class="flex flex-wrap justify-center gap-3 mb-12">
      <button 
        class="category-filter px-4 py-2 rounded-full bg-blue-600 text-white font-medium transition-colors"
        data-category="all"
      >
        All Posts
      </button>
      {categories.map(category => (
        <button 
          class="category-filter px-4 py-2 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 font-medium transition-colors"
          data-category={category}
        >
          {category}
        </button>
      ))}
    </div>

    <!-- Blog Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
      {sortedPosts.map(post => {
        const url = post.data.url || `/blog/${post.id}/`;
        const categoryList = (post.data.categories || []).join(' ');
        
        return (
          <article 
            class="blog-card bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow"
            data-categories={categoryList}
          >
            <div class="p-6">
              {/* Category Tags */}
              <div class="flex flex-wrap gap-2 mb-3">
                {(post.data.categories || []).map(cat => (
                  <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
                    {cat}
                  </span>
                ))}
              </div>
              
              {/* Title */}
              <h2 class="text-xl font-bold mb-3 line-clamp-2">
                <a href={url} class="hover:text-blue-600 transition-colors">
                  {post.data.title}
                </a>
              </h2>
              
              {/* Description */}
              <p class="text-gray-600 mb-4 line-clamp-3">
                {post.data.description}
              </p>
              
              {/* Meta Info */}
              <div class="flex items-center justify-between text-sm text-gray-500">
                {post.data.date && (
                  <time datetime={post.data.date}>
                    {new Date(post.data.date).toLocaleDateString('en-CA', {
                      year: 'numeric',
                      month: 'short',
                      day: 'numeric'
                    })}
                  </time>
                )}
                <a href={url} class="text-blue-600 hover:text-blue-800 font-medium">
                  Read More â†’
                </a>
              </div>
            </div>
          </article>
        );
      })}
    </div>

    <!-- CTA Section -->
    <div class="mt-16 bg-blue-50 rounded-lg p-8 text-center">
      <h2 class="text-2xl font-bold mb-4">Need Professional Help?</h2>
      <p class="text-gray-700 mb-6 max-w-2xl mx-auto">
        While our guides provide valuable information, some waterproofing issues require professional expertise. 
        Get a free assessment from Toronto's trusted waterproofing experts.
      </p>
      <a 
        href="/contact/" 
        class="inline-flex items-center px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors"
      >
        Get Free Quote
      </a>
    </div>
  </div>

  <script>
    // Category filtering
    document.addEventListener('DOMContentLoaded', () => {
      const filters = document.querySelectorAll('.category-filter');
      const cards = document.querySelectorAll('.blog-card');
      
      filters.forEach(filter => {
        filter.addEventListener('click', () => {
          // Update active state
          filters.forEach(f => {
            f.classList.remove('bg-blue-600', 'text-white');
            f.classList.add('bg-gray-200', 'text-gray-700');
          });
          filter.classList.remove('bg-gray-200', 'text-gray-700');
          filter.classList.add('bg-blue-600', 'text-white');
          
          // Filter cards
          const category = filter.dataset.category;
          
          cards.forEach(card => {
            if (category === 'all') {
              card.style.display = 'block';
            } else {
              const cardCategories = card.dataset.categories || '';
              if (cardCategories.includes(category)) {
                card.style.display = 'block';
              } else {
                card.style.display = 'none';
              }
            }
          });
        });
      });
    });
  </script>

  <style>
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</MainLayout>