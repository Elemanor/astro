---
import { getCollection } from 'astro:content';
import MainLayout from '../../layouts/MainLayout.astro';
import Hero from '../../components/ui/Hero.astro';
import Section from '../../components/ui/Section.astro';
import Grid from '../../components/ui/Grid.astro';
import ContentCard from '../../components/ui/ContentCard.astro';
import AstroButton from '../../components/ui/AstroButton.astro';
import AstroBadge from '../../components/ui/AstroBadge.astro';
import { Filter, BookOpen } from 'lucide-react';

// Get all blog posts
const blogPosts = await getCollection('blog');

// Sort by date (newest first)
const sortedPosts = blogPosts.sort((a, b) => {
  const dateA = new Date(a.data.date || 0);
  const dateB = new Date(b.data.date || 0);
  return dateB.getTime() - dateA.getTime();
});

// Group posts by category
const categories = [...new Set(blogPosts.flatMap(post => post.data.categories || []))];

// Get featured posts (first 3 or posts marked as featured)
const featuredPosts = sortedPosts
  .filter(post => post.data.featured)
  .slice(0, 3)
  .concat(sortedPosts.slice(0, 3))
  .slice(0, 3);
---

<MainLayout 
  title="Blog - Basement Waterproofing Guides & Tips | DrySpace" 
  description="Expert insights on basement waterproofing, foundation repair, and home protection. Learn from Toronto's leading waterproofing professionals."
>
  <!-- Hero Section -->
  <Hero
    title="Waterproofing Knowledge Center"
    subtitle="Expert insights, tips, and guides to protect your Toronto home"
    description="Learn from our 25+ years of experience in basement waterproofing and foundation repair"
    badge="DrySpace Blog"
    alignment="center"
    size="small"
  />
  
  <!-- Featured Posts -->
  <Section 
    title="Featured Articles"
    subtitle="Our most popular and helpful guides"
    background="muted"
  >
    <Grid columns={3}>
      {featuredPosts.map(post => {
        const url = post.data.url || `/blog/${post.id}/`;
        return (
          <ContentCard
            title={post.data.title}
            description={post.data.description}
            href={url}
            date={post.data.date}
            categories={post.data.categories}
            type="blog"
            featured={true}
          />
        );
      })}
    </Grid>
  </Section>
  
  <!-- All Posts with Filtering -->
  <Section>
    <div class="space-y-8">
      <!-- Category Filter -->
      <div class="flex flex-col sm:flex-row items-center justify-between gap-4 pb-6 border-b">
        <h2 class="text-2xl font-bold flex items-center gap-2">
          <BookOpen className="h-6 w-6 text-primary" client:load />
          All Articles
        </h2>
        
        <div class="flex flex-wrap justify-center gap-2">
          <button 
            class="category-filter px-4 py-2 rounded-md bg-primary text-primary-foreground font-medium transition-all"
            data-category="all"
          >
            All Posts
          </button>
          {categories.map(category => (
            <button 
              class="category-filter px-4 py-2 rounded-md bg-muted text-muted-foreground hover:bg-muted/80 font-medium transition-all"
              data-category={category}
            >
              {category}
            </button>
          ))}
        </div>
      </div>
      
      <!-- Blog Grid -->
      <Grid columns={3}>
        {sortedPosts.map(post => {
          const url = post.data.url || `/blog/${post.id}/`;
          const categoryList = (post.data.categories || []).join(' ');
          
          return (
            <div class="blog-card" data-categories={categoryList}>
              <ContentCard
                title={post.data.title}
                description={post.data.description}
                href={url}
                date={post.data.date}
                categories={post.data.categories}
                tags={post.data.tags}
                type="blog"
              />
            </div>
          );
        })}
      </Grid>
    </div>
  </Section>
  
  <!-- CTA Section -->
  <Section background="primary" spacing="large">
    <div class="text-center space-y-6">
      <h2 class="text-3xl font-bold text-white">Need Professional Help?</h2>
      <p class="text-xl text-white/90 max-w-2xl mx-auto">
        While our guides provide valuable information, some waterproofing issues require professional expertise. 
        Get a free assessment from Toronto's trusted waterproofing experts.
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <AstroButton 
          href="/contact/" 
          size="lg"
          class="bg-white text-primary hover:bg-gray-100"
        >
          Get Free Quote
        </AstroButton>
        <AstroButton 
          href="tel:437-545-0067" 
          variant="outline" 
          size="lg"
          class="border-white text-white hover:bg-white/10"
        >
          Call (437) 545-0067
        </AstroButton>
      </div>
    </div>
  </Section>
  
  <script>
    // Category filtering with smooth transitions
    document.addEventListener('DOMContentLoaded', () => {
      const filters = document.querySelectorAll('.category-filter');
      const cards = document.querySelectorAll('.blog-card');
      
      filters.forEach(filter => {
        filter.addEventListener('click', () => {
          // Update active state
          filters.forEach(f => {
            f.classList.remove('bg-primary', 'text-primary-foreground');
            f.classList.add('bg-muted', 'text-muted-foreground');
          });
          filter.classList.remove('bg-muted', 'text-muted-foreground');
          filter.classList.add('bg-primary', 'text-primary-foreground');
          
          // Filter cards with animation
          const category = filter.dataset.category;
          
          cards.forEach(card => {
            const shouldShow = category === 'all' || 
              (card.dataset.categories || '').includes(category);
            
            if (shouldShow) {
              card.style.display = 'block';
              card.style.animation = 'fadeIn 0.3s ease-in-out';
            } else {
              card.style.animation = 'fadeOut 0.3s ease-in-out';
              setTimeout(() => {
                card.style.display = 'none';
              }, 300);
            }
          });
        });
      });
    });
  </script>
  
  <style>
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeOut {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(-10px);
      }
    }
  </style>
</MainLayout>